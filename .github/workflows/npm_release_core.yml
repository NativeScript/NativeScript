name: '@nativescript/core -> npm'
permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        type: choice
        default: auto
        description: What kind of version upgrade
        options: 
        - auto
        - patch
        - minor
        - major
        - none


jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@ee0669bd1cc54295c223e0bb666b733df41de1c5 # v2.7.0
        with:
          fetch-depth: "0"
          submodules: true

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: 'https://registry.npmjs.org'
      
      - uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}

      - uses: oleksiyrudenko/gha-git-credentials@8bb1fe6d543b2233ef1856cd3b0181f5abbd4d6a # v2.1.2
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          name: Martin Guillon
          email: dev@akylas.fr
      
      - name: "NPM Identity"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc

      - name: Enable CorePack
        run: |
          corepack enable 
          yarn config get globalFolder # the yarn command will ensure the correct yarn version is downloaded and installed

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn config get globalFolder)"

      - name: Install deps
        uses: bahmutov/npm-install@v1
        with:
          install-command: yarn install --silent
        env: 
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
  

      - name: bump release auto
        if: github.event.inputs.release_type == 'auto' 
        run: |
          npm run core:changelog --

      - name: publish
        if: github.event.inputs.release_type != 'auto' && github.event.inputs.release_type != 'none'
        run: |
          npm run core:changelog -- --release-as ${{ github.event.inputs.release_type }}

      - name: publish
        run: |
          npm run core:publish -- --no-verify-access --no-private --no-commit-hooks --force-publish --yes
          git push --tags
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
